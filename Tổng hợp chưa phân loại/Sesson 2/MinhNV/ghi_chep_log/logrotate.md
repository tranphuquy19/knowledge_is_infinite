# Tìm hiểu về LogrotateLOGROTATE là một tiện ích tuyệt vời trên Linux giúp đơn giản hóa việc quản lý log files trên hệ thống, bao gồm xoay vòng file log, di chuyển, nén, gửi tự động… Rotate (xoay vòng) ở đây có thể hiểu là tiến trình xử lý file log cũ theo quy định trước đó (xóa/nén/move) đồng thời tạo ra file log mới.Bằng cách thiết lập đơn giản nhưng chặt chẽ thông qua file cấu hình, Logrotate hoạt động một cách tự động, không cần can thiệp thủ công.Log files rất quan trọng đối với quản trị viên để theo dõi tình trạng của hệ thống/ứng dụng, tuy vậy nếu quá nhiều log file sẽ khiến dung lượng ổ cứng bị quá tải cũng như gây khó khăn trong việc tìm kiếm thông tin cần thiết.## 1. Cài đặt Logrotate được cài đặt mặc định trên hầu hết các bản phân phối Linux. Bạn có thể kiểm tra bằng lệnh # logrotate với kết quả như sau:```sh[root@pxe-server ~]# logrotatelogrotate 3.8.6 - Copyright (C) 1995-2001 Red Hat, Inc.This may be freely redistributed under the terms of the GNU Public LicenseUsage: logrotate [-dfv?] [-d|--debug] [-f|--force] [-m|--mail command] [-s|--state statefile] [-v|--verbose] [-l|--log STRING] [--version]        [-?|--help] [--usage] [OPTION...] <configfile>```Còn nếu chưa được cài đặt bạn có thể tiến hành cài đặt- Đối với Ubuntu```shsudo apt-get updatesudo apt-get install logrotate```- Đối với Centos ```shsudo yum updatesudo yum install logrotate```## 2. Cấu hình LogrotateCấu hình Logrotate được lưu tại `/etc/logrotate.conf`, chứa thông tin thiết lập toàn bộ log files mà Logrotate quản lý, bao gồm chu kì lặp, dung lượng file log, nén file…```sh# see "man logrotate" for details# rotate log files weeklyweekly# keep 4 weeks worth of backlogsrotate 4# create new (empty) log files after rotating old onescreate# use date as a suffix of the rotated filedateext# uncomment this if you want your log files compressed#compress# RPM packages drop log rotation information into this directoryinclude /etc/logrotate.d# no packages own wtmp and btmp -- we'll rotate them here/var/log/wtmp {    monthly    create 0664 root utmp        minsize 1M    rotate 1}/var/log/btmp {    missingok    monthly    create 0600 root utmp    rotate 1}# system-specific logs may be also be configured here.```- `weekly`: File log được rotate hàng tuần.- `rotate 4`: Giữ lại file log trong 4 tuần - `create`: Tạo ra file log mới sau khi rotate - `dateext`: Thêm hậu tố ngày tháng năm vào sau tên file log- `compress`: Các file này được nén dưới dang gzipThông tin cấu hình log file của từng ứng dụng cụ thể được lưu tại `/etc/logrotate.d/`Ví dụ cấu hình rotate log file cho MySQL `/etc/logrotate.d/mysql````sh/home/*/logs/mysql*.log {        # create 600 mysql mysql        notifempty        daily        rotate 3        maxage 7        missingok        compress        postrotate        # just if mysqld is really running        if test -x /usr/bin/mysqladmin &&            /usr/bin/mysqladmin ping &>/dev/null        then           /usr/bin/mysqladmin flush-logs        fi        endscript}```Có thể thấy, cấu hình Logrotate với cấu trúc gồm chỉ định đường dẫn và cấu hình các option trong dấu `{}`### 2.1 Lựa chọn Log file được rotateBạn có thể chỉ định cụ thể một hay nhiều file log với đường dẫn cụ thể của file log đó, phân biệt danh sách các log file cụ thể bằng khoảng trắng. Ví dụ:```sh/var/log/btmp/home/*/logs/mysql*.log/home/*/logs/access.log /home/*/logs/error.log /home/*/logs/nginx_error.log```### 2.2. Rotate theo thời gianCó 4 giá trị cấu hình tương ứng với khoảng thời gian log file sẽ được rotate.- `Daily`: mỗi ngày- `Weekly`: mỗi đầu tuần- `Monthly`: mỗi đầu tháng- `Yearly`: mỗi năm### 2.3. Rotate theo dung lượng file logTa có thể quy định tiến trình rotate dựa vào dung lượng file, ví dụ nếu file đó đạt dung lượng 100mb thì tiến hành rotate. Các đơn vị kích thước file có thể sử dụng là K, M, G.```shsize 100ksize 100Msize 100G```Cấu hình rotate dựa theo dung lượng file luôn được ưu tiên cao hơn rotate dựa vào thời gian. Khi đó, nếu 1 file log được rotate theo cấu hình dung lượng file quy định thì thời gian rotate sẽ được khởi động lại mới.Ví dụ, log file được cấu hình rotate theo tuần weekly và theo dung lượng 100mb. Tuy vậy, đến giữa tuần log file được rotate do dung lượng file đạt 100M. Khi đó, Logrotate sẽ phải đợi sang tuần kế tiếp để thực hiện rotate log, do việc rotate theo size đã bỏ qua luôn thời gian của tuần này.### 2.4. Xử lý Log file trốngTham số missingok: nếu file log vì lý do gì đấy bị mất hoặc không tồn tại *.log thì logrotate sẽ tự động di chuyển tới phần cấu hình log của file log khác mà không cần phải xuất ra thông báo lỗi. Ngược lại sẽ là cấu hình nomissingokTham số Notifempty: không rotate log nếu file log này trống.### 2.5 Rotate theo số lượng Log file`rotate [number]` : Quy định số lượng log file cũ đã được giữ lại sau khi rotate.Ví dụ có 5 file log cũ thì file log cũ nhất sẽ bị xóa ### 2.6 Tự động nén file logTùy chọn ``Compress``: Logrotate sẽ nén tất cả các file log lại sau khi đã được rotate, mặc định bằng gzip.Tùy chọn ``nocompress``: Không sử dụng tính năng nén đối với file log cũNếu bạn muốn sử dụng chương trình nén khác như bzip2, xz hoặc zip thì hãy đặt tên chương trình đó thành biến sau giá trị cấu hình `Compresscmd xz`Tham số `Delaycompress` sẽ hữu dụng trong trường hợp bạn không muốn file log cũ phải nén ngay sau khi vừa được rotate. Thay vào đó, công việc nén sẽ được delay trễ hơn bằng việc sẽ nén file log cũ đó vào lần chạy rotate kế tiếp. Tùy chọn này chỉ hoạt động đi kèm chức năng compress trong file cấu hình, tức bạn phải cấu hình compress trước đó:```shcompressdelaycompress```### 2.7. Phân quyền cho Log fileCấu hình tham số `create` sẽ quy định việc file log mới tạo ra( ngược lại là option `nocreate` ). Bạn cần đảm bảo đúng phân quyền cho file log mới sau khi rotate.``create 660 appuser www-data``File log mới sẽ có owner là `appuser` và thuộc group `www-data` (group mà Apache thường chạy). Quyền hạn `660` cho phép cả owner và user trong cùng 1 nhóm được phép viết, sửa nội dung lên file. Điều này cho phép các ứng dụng PHP viết vào log file.### 2.8. Thực thi scripts trước hoặc sau khi rotateĐể chạy một số lệnh trước khi quá trình rotate bắt đầu, ta đặt lệnh thực thi nằm giữa `prerotate` và `endscript`.```shPrerotateTouch /var/www/html/stop.txtEndscript```Để chạy lệnh sau khi quá trình rotate kết thúc, ta đặt lệnh thực thi nằm giữa `postrotate` và `endscript`.```shPostrotate/etc/init.d/apache2 reload > /dev/nullEndscript````sharedscripts`: Script postrotate sẽ được chạy sau khi toàn bộ các file logs được rotate. Nếu không có tùy chọn này, postrotate script sẽ được chạy sau mỗi log file được rotate.## 3. Kiểm tra LogRotate- Sử dụng lệnh sau để kiểm tra cấu hình ``logrotate -d /etc/logrotate.d/mysql``Nếu output không xuất hiện lỗi thì cấu hình của bạn đã đúng.- Rotate thủ công ``logrotate -vf /etc/logrotate.d/mysql``Trong đó 	+ `-v`: Hiển thị nhiều thông tin hơn	+ `f`: Rolate ngay lập tức## 4. Tài liệu tham khảo - http://www.thegeekstuff.com/2010/07/logrotate-examples- https://linux.die.net/man/8/logrotate