# Tìm hiểu về iperf commands## Thay đổi giữa iPerf 2.0, iPerf 3.0 và iPerf 3.1Các tính năng iPerf2 hiện được hỗ trợ bởi iPerf3:- Kiểm tra TCP và UDP- Đặt cổng (-p)- Thiết lập các tùy chọn TCP: Không có sự chậm trễ, MSS, vv- Thiết lập băng thông UDP (-b)- Thiết lập kích thước bộ đệm socket (-w)- Các khoảng báo cáo (-i)- Thiết lập bộ đệm iPerf (-l)- Liên kết với các giao diện cụ thể (-B)- Kiểm tra IPv6 (-6)- Số byte để truyền (-n)- Chiều dài kiểm tra (-t)- Các luồng song song (-P)- Thiết lập các vector vectơ DSCP / TOS (-S)- Thay đổi định dạng đầu ra số (-f)Các tính năng mới trong iPerf 3.0:- Hầu hết các tùy chọn máy chủ từ iPerf2 bây giờ có thể được tự động thiết lập bởi client- -4, --version4 : chỉ sử dụng IPv4- -6, --version6 : chỉ sử dụng IPv6- -s, --server: iPerf2 có thể xử lý nhiều yêu cầu của khách hàng. IPerf3 sẽ chỉ cho phép một kết nối iperf tại một thời điểm.- -J, --json: xuất ở định dạng JSON- -Z, --zerocopy: sử dụng phương thức gửi dữ liệu 'zero copy' sendfile () Điều này sử dụng CPU ít hơn nhiều.<đang cập nhập>Các tính năng mới trong iPerf 3.1:- -I, --piffile file viết một tập tin với quá trình ID, hữu ích nhất khi chạy như một daemon.- --cport: Chỉ định cổng phía máy khách.- --sctp sử dụng SCTP chứ không phải là TCP (Linux, FreeBSD và Solaris).- --dup-counters-64bit: Hỗ trợ các bài kiểm tra UDP chạy rất lâu, có thể gây ra lỗi tràn- --logfile file: gửi đầu ra cho một file log.Tính năng iPerf2 Không được hỗ trợ bởi iPerf3:- Kiểm tra hai chiều (-d / -r)- Dữ liệu truyền từ stdin (-I)- TTL: thời gian sống, cho multicast (-T)- Loại trừ C(connection) D(data) M(multicast) S(settings) V(server) reports (-x)- Báo cáo dưới dạng một giá trị Comma-Separated (-y)- Chế độ tương thích cho phép sử dụng với phiên bản cũ của iPerf (-C)## 1. Cài đặt- Trên Ubuntu``apt-get install iperf``- Trên CentOS``yum install iperf``## 2. Một số option thường dung| Tham số | Tác dụng ||---------|----------|| -c | chỉ ra địa chỉ IP của server để iperf kết nối đến || -f, --format | Chỉ ra định dạng của kết quả hiển thị. 'b' = bps, 'B' = Bps, 'k' = Kbps, 'K' = KBps,... || -i, --interval | Thời gian lấy mẫu để hiển thị kết quả tại thời điểm đó ra màn hình || -p, --port | Định ra cổng để nghe, mặc định nếu không sử dụng tham số này là cổng 5001 || -u, --udp | Sử dụng giao thức UDP, mặc định iperf sử dụng TCP || -P, --parallel | Chỉ ra số kết nối song song được tạo, nếu là Server mode thì đây là giới hạn số kết nối mà server chấp nhận || -b | Định ra băng thông tối ta có thể truyền, chỉ sử dụng với UDP, client mode || -t | Tổng thời gian của kết nối, tính bằng giây || -M | Max segment size || -l | Buffer size || -w, --window | Trường Windows size của TCP |## 3. Thực hành ### Mô hình server-client<img src="http://i.imgur.com/h3Tjl6r.png">Trong mô hình có 1 máy làm server để lắng nghe, một máy client kết nối đến để kiểm tra băng thông của mạng. Ta có thể dung giao thức UDP hoặc TCP.###  Sử dung TCPCả máy server và client đều cần cài iperf.Nếu sử dụng tham số cổng (-p) thì trên cả Server và client đều phải giống cổng nhau.- Ví dụ một bài test đơn giản:server:	iperf -s    Client: 	iperf -c 192.168.100.60    Sau 10 giây kết quả sẽ trả về trên màn hình.```sh[root@localhost ~]# iperf -c 192.168.100.60------------------------------------------------------------Client connecting to 192.168.100.60, TCP port 5001TCP window size: 85.0 KByte (default)------------------------------------------------------------[  3] local 192.168.100.61 port 58862 connected with 192.168.100.60 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0-10.0 sec   591 MBytes   496 Mbits/sec```- Ví dụ bài test TCP với Buffer size: 20 MB, Window Size: 60 Mbps, Max segment size 5 trong thời gian 5 phút, kết quả hiển thị dưới dạng mbpsServer:    iperf -s -P 0 -i 1 -p 5001 -w 60.0m -l 20.0M -f m    Client:        iperf -c 192.168.100.60 -i 1 -p 5001 -w 60.0m -M 1.0K -l 20.0M -f m -t 300Kết quả ```sh[root@localhost ~]#  iperf -c 192.168.100.60 -i 1 -p 5001 -w 60.0m -M 1.0K -l 20.0M -f m -t 300WARNING: attempt to set TCP maximum segment size to 1024, but got 536------------------------------------------------------------Client connecting to 192.168.100.60, TCP port 5001TCP window size: 0.41 MByte (WARNING: requested 60.0 MByte)------------------------------------------------------------[  3] local 192.168.100.61 port 58880 connected with 192.168.100.60 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0- 1.0 sec  60.0 MBytes   503 Mbits/sec[  3]  1.0- 2.0 sec  20.0 MBytes   168 Mbits/sec[  3]  2.0- 3.0 sec  39.6 MBytes   332 Mbits/sec[  3]  3.0- 4.0 sec  39.4 MBytes   330 Mbits/sec[  3]  4.0- 5.0 sec  38.2 MBytes   321 Mbits/sec[  3]  5.0- 6.0 sec  35.5 MBytes   298 Mbits/sec[  3]  6.0- 7.0 sec  40.0 MBytes   336 Mbits/sec[  3]  7.0- 8.0 sec  19.9 MBytes   167 Mbits/sec[  3]  8.0- 9.0 sec  40.0 MBytes   335 Mbits/sec[  3]  9.0-10.0 sec  37.3 MBytes   313 Mbits/sec[  3] 10.0-11.0 sec  35.4 MBytes   297 Mbits/sec[  3] 11.0-12.0 sec  40.0 MBytes   336 Mbits/sec[  3] 12.0-13.0 sec  38.2 MBytes   321 Mbits/sec[  3] 13.0-14.0 sec  18.3 MBytes   154 Mbits/sec[  3] 14.0-15.0 sec  37.9 MBytes   318 Mbits/sec[  3] 15.0-16.0 sec  39.4 MBytes   331 Mbits/sec[  3] 16.0-17.0 sec  38.9 MBytes   327 Mbits/sec[  3] 17.0-18.0 sec  40.0 MBytes   336 Mbits/sec[  3] 18.0-19.0 sec  37.6 MBytes   315 Mbits/sec[  3] 19.0-20.0 sec  19.4 MBytes   162 Mbits/sec```### Sử dụng UDP- Ví dụ một bài test đơn giảnServer:    iperf -s -u    Client:    iperf -c 192.168.100.60 -u    Sau 10 giây kết quả sẽ trả về trên màn hình.```sh[root@localhost ~]# iperf -c 192.168.100.60 -u------------------------------------------------------------Client connecting to 192.168.100.60, UDP port 5001Sending 1470 byte datagrams, IPG target: 11215.21 us (kalman adjust)UDP buffer size:  208 KByte (default)------------------------------------------------------------[  3] local 192.168.100.61 port 41665 connected with 192.168.100.60 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec[  3] Sent 893 datagrams[  3] Server Report:[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec   0.023 ms    0/  893 (0%)```- Ví dụ bài test UDP với Bandwidth 500 Mbps Packet size 500 Bytes trong 120sServer:    iperf -s -u -P 0 -i 1 -p 5001 -f mClient:    iperf -c 192.168.100.60 -u -i 1 -p 5001 -l 500B -f m -b 500m -t 120Kết quả ```sh[root@localhost ~]# iperf -c 192.168.100.60 -u -i 1 -p 5001 -l 500B -f m -b 500m -t 120------------------------------------------------------------Client connecting to 192.168.100.60, UDP port 5001Sending 500 byte datagrams, IPG target: 8.00 us (kalman adjust)UDP buffer size: 0.20 MByte (default)------------------------------------------------------------[  3] local 192.168.100.61 port 36445 connected with 192.168.100.60 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0- 1.0 sec  29.5 MBytes   248 Mbits/sec[  3]  1.0- 2.0 sec  22.2 MBytes   186 Mbits/sec[  3]  2.0- 3.0 sec  24.5 MBytes   206 Mbits/sec[  3]  3.0- 4.0 sec  24.4 MBytes   205 Mbits/sec[  3]  4.0- 5.0 sec  21.7 MBytes   182 Mbits/sec[  3]  5.0- 6.0 sec  23.1 MBytes   194 Mbits/sec[  3]  6.0- 7.0 sec  26.9 MBytes   226 Mbits/sec[  3]  7.0- 8.0 sec  22.0 MBytes   185 Mbits/sec[  3]  8.0- 9.0 sec  20.0 MBytes   168 Mbits/sec[  3]  9.0-10.0 sec  28.4 MBytes   238 Mbits/sec[  3] 10.0-11.0 sec  39.1 MBytes   328 Mbits/sec[  3] 11.0-12.0 sec  28.7 MBytes   241 Mbits/sec[  3] 12.0-13.0 sec  22.1 MBytes   185 Mbits/sec[  3] 13.0-14.0 sec  22.1 MBytes   185 Mbits/sec[  3] 14.0-15.0 sec  21.7 MBytes   182 Mbits/sec[  3] 15.0-16.0 sec  22.6 MBytes   189 Mbits/sec[  3] 16.0-17.0 sec  23.1 MBytes   194 Mbits/sec[  3] 17.0-18.0 sec  22.5 MBytes   189 Mbits/sec[  3] 18.0-19.0 sec  23.5 MBytes   197 Mbits/sec[  3] 19.0-20.0 sec  21.9 MBytes   183 Mbits/sec```Kết quả trên cho chúng ta thấy được cứ mỗi giây sẽ gửi đi một gói tin có lưu lượng trong phần `transfer` , và kết quả chúng ta sẽ thấy được lượng băng thông trung bình ở cột `Bandwidth`.- Kiểm tra lưu lượng tối đa trên một card mạng có thể truyển tải được.Để làm việc này ta có thể đẩy tải liên lục bằng UDP tại máy chủ, do UDP truyền file mà không cần phải bắt tay 3 bước như TCP nên ta có thể đẩy UDP liên lục từ client, thay đổi băng thông và quan sát băng thông tối đa mà nó đạt được, đó cũng chính là giới hạn của card mạng.Tiến hành kiểm tra card ens3 trên server 192.168.100.60``iperf -c 192.168.100.1 -u -b 100m -t 100 -i 1``	```sh[root@localhost ~]# iperf -c 192.168.100.1 -u -b 100m -t 100 -i 1------------------------------------------------------------Client connecting to 192.168.100.1, UDP port 5001Sending 1470 byte datagrams, IPG target: 117.60 us (kalman adjust)UDP buffer size:  208 KByte (default)------------------------------------------------------------[  3] local 192.168.100.60 port 52127 connected with 192.168.100.1 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0- 1.0 sec  11.9 MBytes   100 Mbits/sec[  3]  1.0- 2.0 sec  11.9 MBytes   100 Mbits/sec[  3]  2.0- 3.0 sec  11.9 MBytes   100 Mbits/sec[  3]  3.0- 4.0 sec  11.9 MBytes   100 Mbits/sec[  3]  4.0- 5.0 sec  11.9 MBytes   100 Mbits/sec[  3]  5.0- 6.0 sec  11.9 MBytes   100 Mbits/sec[  3]  6.0- 7.0 sec  11.9 MBytes   100 Mbits/sec[  3]  7.0- 8.0 sec  11.9 MBytes   100 Mbits/sec[  3]  8.0- 9.0 sec  11.9 MBytes   100 Mbits/sec[  3]  9.0-10.0 sec  11.9 MBytes   100 Mbits/sec[  3] 10.0-11.0 sec  11.9 MBytes   100 Mbits/sec[  3] 11.0-12.0 sec  11.9 MBytes   100 Mbits/sec[  3] 12.0-13.0 sec  11.9 MBytes   100 Mbits/sec[  3] 13.0-14.0 sec  11.9 MBytes   100 Mbits/sec[  3] 14.0-15.0 sec  11.9 MBytes   100 Mbits/sec[  3] 15.0-16.0 sec  11.9 MBytes   100 Mbits/sec[  3] 16.0-17.0 sec  11.9 MBytes   100 Mbits/sec[  3] 17.0-18.0 sec  11.9 MBytes   100 Mbits/sec[  3] 18.0-19.0 sec  11.9 MBytes   100 Mbits/sec[  3] 19.0-20.0 sec  11.9 MBytes   100 Mbits/sec```Ta thấy dữ liệu gửi đi và Bandwidth không hề thay đổi suy ra đây chưa phải lưu lượng tối đa có thể truyền tải được. Chúng ta tăng lượng lưu lượng cần tryền tải lên rồi tiếp tục kiểm tra.``iperf -c 192.168.100.1 -u -b 500m -t 100 -i 1``Kết quả thu được ```sh[root@localhost ~]# iperf -c 192.168.100.1 -u -b 500m -t 100 -i 1------------------------------------------------------------Client connecting to 192.168.100.1, UDP port 5001Sending 1470 byte datagrams, IPG target: 23.52 us (kalman adjust)UDP buffer size:  208 KByte (default)------------------------------------------------------------[  3] local 192.168.100.60 port 37437 connected with 192.168.100.1 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0- 1.0 sec  59.6 MBytes   500 Mbits/sec[  3]  1.0- 2.0 sec  59.6 MBytes   500 Mbits/sec[  3]  2.0- 3.0 sec  59.6 MBytes   500 Mbits/sec[  3]  3.0- 4.0 sec  59.6 MBytes   500 Mbits/sec[  3]  4.0- 5.0 sec  59.6 MBytes   500 Mbits/sec[  3]  5.0- 6.0 sec  59.6 MBytes   500 Mbits/sec[  3]  6.0- 7.0 sec  59.6 MBytes   500 Mbits/sec[  3]  7.0- 8.0 sec  59.6 MBytes   500 Mbits/sec[  3]  8.0- 9.0 sec  59.6 MBytes   500 Mbits/sec[  3]  9.0-10.0 sec  59.6 MBytes   500 Mbits/sec[  3] 10.0-11.0 sec  59.6 MBytes   500 Mbits/sec[  3] 11.0-12.0 sec  59.6 MBytes   500 Mbits/sec[  3] 12.0-13.0 sec  59.6 MBytes   500 Mbits/sec[  3] 13.0-14.0 sec  59.6 MBytes   500 Mbits/sec[  3] 14.0-15.0 sec  59.6 MBytes   500 Mbits/sec[  3] 15.0-16.0 sec  59.6 MBytes   500 Mbits/sec[  3] 16.0-17.0 sec  59.6 MBytes   500 Mbits/sec[  3] 17.0-18.0 sec  59.6 MBytes   500 Mbits/sec[  3] 18.0-19.0 sec  59.6 MBytes   500 Mbits/sec```Tiếp tục tăng lưu lượng truyền tải tối đa lên 1g```iperf -c 192.168.100.1 -u -b 1g -t 100 -i 1``Kết quả thu được ```sh[root@localhost ~]# iperf -c 192.168.100.1 -u -b 1g -t 100 -i 1------------------------------------------------------------Client connecting to 192.168.100.1, UDP port 5001Sending 1470 byte datagrams, IPG target: 11.76 us (kalman adjust)UDP buffer size:  208 KByte (default)------------------------------------------------------------[  3] local 192.168.100.60 port 37034 connected with 192.168.100.1 port 5001[ ID] Interval       Transfer     Bandwidth[  3]  0.0- 1.0 sec  85.7 MBytes   719 Mbits/sec[  3]  1.0- 2.0 sec  93.2 MBytes   782 Mbits/sec[  3]  2.0- 3.0 sec  95.9 MBytes   805 Mbits/sec[  3]  3.0- 4.0 sec  92.8 MBytes   778 Mbits/sec[  3]  4.0- 5.0 sec  93.6 MBytes   785 Mbits/sec[  3]  5.0- 6.0 sec  93.5 MBytes   784 Mbits/sec[  3]  6.0- 7.0 sec  93.8 MBytes   787 Mbits/sec[  3]  7.0- 8.0 sec  93.6 MBytes   785 Mbits/sec[  3]  8.0- 9.0 sec  94.0 MBytes   789 Mbits/sec[  3]  9.0-10.0 sec  94.0 MBytes   789 Mbits/sec[  3] 10.0-11.0 sec  94.3 MBytes   791 Mbits/sec[  3] 11.0-12.0 sec  93.3 MBytes   782 Mbits/sec[  3] 12.0-13.0 sec  93.0 MBytes   780 Mbits/sec[  3] 13.0-14.0 sec  93.4 MBytes   784 Mbits/sec[  3] 14.0-15.0 sec  93.4 MBytes   783 Mbits/sec[  3] 15.0-16.0 sec  93.5 MBytes   784 Mbits/sec[  3] 16.0-17.0 sec  94.3 MBytes   791 Mbits/sec[  3] 17.0-18.0 sec  94.0 MBytes   789 Mbits/sec[  3] 18.0-19.0 sec  94.3 MBytes   791 Mbits/sec[  3] 19.0-20.0 sec  93.5 MBytes   785 Mbits/sec[  3] 20.0-21.0 sec  93.4 MBytes   784 Mbits/sec[  3] 21.0-22.0 sec  93.7 MBytes   786 Mbits/sec[  3] 22.0-23.0 sec  93.3 MBytes   782 Mbits/sec[  3] 23.0-24.0 sec  93.3 MBytes   783 Mbits/sec[  3] 24.0-25.0 sec  93.3 MBytes   783 Mbits/sec```Tiếp tục kiểm tra chúng ta sẽ thấy được tốc độ tối đa của card mạng