# Hướng dẫn cài đặt OpenVPN trên Ubuntu 14.04**Mô hình**<img src="http://i.imgur.com/lgL2FWl.png">**Lưu ý**- Tất cả đều thực hiện dưới quyền `root`.### 1. Cài đặt và cấu hình OpenVPN server.- Trước tiên chúng ta update danh sách Ubuntu's repository.```shapt-get update```- Sau đó chúng ta cần cài đặt `OpenVPN` và `Easy-RSA````shapt-get install openvpn easy-rsa```- Trích xuất tập tin cấu hình vào `/etc/openvpn````shgunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz > /etc/openvpn/server.conf```- Chỉnh sửa file `server.conf` , mở nó bằng trình soạn thảo `vi````shvi /etc/openvpn/server.conf```Chúng ta cần chỉnh sửa một số tùy chọn như sau :dh dh1024.pem- Sửa thành :dh dh2048.pem- Tìm và bỏ dấu ";" đằng trước các dòng sau :```sh;push "redirect-gateway def1 bypass-dhcp";push "dhcp-option DNS 208.67.222.222";push "dhcp-option DNS 208.67.220.220";user nobody;group nogroup```- Chuyển thành :```shpush "redirect-gateway def1 bypass-dhcp"push "dhcp-option DNS 208.67.222.222"push "dhcp-option DNS 208.67.220.220"user nobodygroup nogroup```- `SAVE` lại.- Kích hoạt tính năng chuyển tiếp gói tin :```shecho 1 > /proc/sys/net/ipv4/ip_forward```- Sử dụng lệnh trên chỉ có tác dụng 1 lần, để có thể sử dụng nhiều lần sau khi reboot máy chủ chúng ta cần phải chỉnh sửabên trong file sau :```shvi /etc/sysctl.conf```- Tìm và bỏ comment dòng sau :```sh# Uncomment the next line to enable packet forwarding for IPv4#net.ipv4.ip_forward=1```- Chuyển thành :```sh# Uncomment the next line to enable packet forwarding for IPv4net.ipv4.ip_forward=1```- Lưu lại thay đổi và thoát ra.<a name="firewall"></a>### 2. Thiết lập Firewall.- Đầu tiên chúng ta cần cho phép được thực hiện SSH bằng lệnh sau:```shufw allow ssh```- Cho phép traffic UDP đi qua port 1194 (port của VPN) ```shufw allow 1194/udp```- Thiếp lập policy :```shvi /etc/default/ufw```- Chỉnh sửa dòng sau :```shDEFAULT_FORWARD_POLICY="DROP"```- CHuyển thành :```shDEFAULT_FORWARD_POLICY="ACCEPT"```- Tiếp theo chúng ta cần add thêm các rules để cho traffic từ client (khi nhận IP tunnel) có thể kết nối qua VPN server.```shvi /etc/ufw/before.rules```Thêm Các dòng sau vào trên đầu của file (Phải để ở đầu, bởi vì Iptables thực hiện các lệnh từ trên xuống dưới do đó để tránh xảy ra lỗi chúng ta nên đặt ở trên đầu) :```sh# START OPENVPN RULES# NAT table rules*nat:POSTROUTING ACCEPT [0:0] # Allow traffic from OpenVPN client to eth0-A POSTROUTING -s 10.8.0.0/8 -o eth0 -j MASQUERADECOMMIT# END OPENVPN RULES```- Enable firewall :```shufw enable```- Chúng ta sẽ nhận được thông báo :```shCommand may disrupt existing ssh connections. Proceed with operation (y|n)?```- CHọn `Y` để tiếp tục.- Kiểm tra sự hoạt động của Firewall :```shufw status```<a name="ca"></a>### 3. Tạo CA và Cert.- Đầu tiên chúng ta coppy `easy-rsa` vào `/etc/openvpn````shcp -r /usr/share/easy-rsa/ /etc/openvpn```- Tạo một thư mục lưu trữ các key.```shmkdir /etc/openvpn/easy-rsa/keys```- Chỉnh sửa các biến trong `easy-rsa````sh# These are the default values for fields# which will be placed in the certificate.# Don't leave any of these fields blank.export KEY_COUNTRY="US"export KEY_PROVINCE="CA"export KEY_CITY="hanoi"export KEY_ORG="minhnv"export KEY_EMAIL="admin@gmail.com"export KEY_OU="minhnv"# X509 Subject Fieldexport KEY_NAME="server"```- Tạo các thông số Diffie-Hellman:```shopenssl dhparam -out /etc/openvpn/dh2048.pem 2048```- Di chuyển tới thư mục `/etc/openvpn/easy-rsa` :```shcd /etc/openvpn/easy-rsa```- Khởi tạo PKI . Hãy chú ý đến các dấu chấm (.) Và không gian phía trước lệnh ./vars. Điều đó có nghĩa các thư mục làm việc hiện tại (nguồn).```sh. ./vars```- Xóa tất cả các dữ liệu cũ còn lưu lại :```sh./clean-all```- Tạo CA.```sh./build-ca```- Tạo Cert cho server :```sh./build-key-server server```- Sao chép vào `/etc/openvpn` bởi vì OpenVPN sẽ chỉ thấy key ở trong thư mục này :```shcp /etc/openvpn/easy-rsa/keys/{server.crt,server.key,ca.crt} /etc/openvpn```- Khởi bộng dịch vụ `OpenVPN````shservice openvpn start```- Tạo Cert cho Client.```sh./build-key client1```- Các tập tin cấu hình cần được sao chép vào mục Easy-RSA. Chúng ta sẽ sử dụng nó như một template mà các client sẽ tải về để chỉnh sửa . Trong quá trình sao chép chúng ta thay đổi tập tin từ `client.conf` thành `client.opvn`.```shcp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/easy-rsa/keys/client.ovpn```### 4. Tải file cấu hình và test thử trên Client.- Các file chúng ta cần tải về đó là :  + client1.crt  + client1.key  + client.ovpn  + ca.crt- Sau khi đã tải xong chúng ta tiến hành sửa file tại máy client.- Chúng ta mở file client.opvn bằng notepad++ và sửa như sau:```shclientdev tunproto udp#Server IP and Portremote #ip_pullic #port resolv-retry infinitenobindpersist-keypersist-tunmute-replay-warningsca ca.crtcert client1.crtkey client1.keyns-cert-type servercomp-lzo# copy đoạn mã trong 3 file ca.crt, client1.crt, client1.key mà chúng ta đã tải về.<ca>-----BEGIN CERTIFICATE-----MIIFDzCCA/egAwIBAgIJAIGtdvDWt6vhMA0GCSqGSIb3DQEBCwUAMIG1MQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFTATBgNVBAcTDFNhbkZyYW5jaXNjbzEVMBMGA1UEChMMRm9ydC1GdW5zdG9uMR0wGwYDVQQLExRNeU9yZ2FuaXphdGlvbmFsVW5pdDEYMBYGA1UEAxMPRm9ydC1GdW5zdG9uIENBMQ8wDQYDVQQpEwZzZXJ2ZXIxITAfBgkqhkiG9w0BCQEWEm1lQG15aG9zdC5teWRvbWFpbjAeFw0xNzA4MjQwODA0NTlaFw0yNzA4MjIwODA0NTlaMIG1MQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFTATBgNVBAcTDFNhbkZyYW5jaXNjbzEVMBMGA1UEChMMRm9ydC1GdW5zdG9uMR0wGwYDVQQLExRNeU9yZ2FuaXphdGlvbmFsVW5pdDEYMBYGA1UEAxMPRm9ydC1GdW5zdG9uIENBMQ8wDQYDVQQpEwZzZXJ2ZXIxITAfBgkqhkiG9w0BCQEWEm1lQG15aG9zdC5teWRvbWFpbjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMq/vCSMrd34uFlNxJvPOQA91ExYjNdKAoVmHARUSd61LskUeFT0emKRkin4ISDsDzVhBGv8+uOFIUnhCdxT4Q161yIezcwEe/8JlmKlCs0gzkle5DH06TQWXrd23zhu/Hd8493XoI6eotls7+v48Q09gT2ptwUcqe0UPyPUJR9slEbNFfijRi30A/D47+MU7tKCyQn4SVhwhrP7A2Ft+NPzUnQAVtTC4QwL/g55ej/vOgYJwO9lfuxhETvUZn7YgB982AZpGMpdkxf7pT/ERa3mPjvUzDU80PkBII/AAjjcA/S9qkGjDip8sNPJcX46AzW/wzYbWGI3q9NXW5cQvs8CAwEAAaOCAR4wggEaMB0GA1UdDgQWBBSUnew8HEC7zPOxeTrnun5Vvg5cKDCB6gYDVR0jBIHiMIHfgBSUnew8HEC7zPOxeTrnun5Vvg5cKKGBu6SBuDCBtTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRUwEwYDVQQHEwxTYW5GcmFuY2lzY28xFTATBgNVBAoTDEZvcnQtRnVuc3RvbjEdMBsGA1UECxMUTXlPcmdhbml6YXRpb25hbFVuaXQxGDAWBgNVBAMTD0ZvcnQtRnVuc3RvbiBDQTEPMA0GA1UEKRMGc2VydmVyMSEwHwYJKoZIhvcNAQkBFhJtZUBteWhvc3QubXlkb21haW6CCQCBrXbw1rer4TAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQB6SealzxgZ+DEhImmaFGRruaSEvHbzX44SZEP8lRnHhaLgDZolReV3dZvM1Ibj5z0Vlj3uuesH81NLyQNwI3K6z1+kjhXrpwEEwcNyufoIZeAulIH6PmYbPDUCEYQs3ZaqHDuQyogY2s1VYyV5PPHxWGgT4CTjVL6QeAYUmHW+2jk/r5i3HFrwZ0Ry6v2e0/wfM9t3yxbEnGaPeVeviS2oleuFd5504pnL1g/T1BVePwynjI+kPFacMJXkFmPJ71Wxh9RkJOVcA8p7b2uN0J+3yfef3MAy069p1BaHAfxcWAglE5vXZx9J7QV8fbjMzIICbbTml8/TAp9sf8EEuBc5-----END CERTIFICATE-----</ca><cert>-----BEGIN CERTIFICATE-----MIIFXzCCBEegAwIBAgIBBTANBgkqhkiG9w0BAQsFADCBtTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRUwEwYDVQQHEwxTYW5GcmFuY2lzY28xFTATBgNVBAoTDEZvcnQtRnVuc3RvbjEdMBsGA1UECxMUTXlPcmdhbml6YXRpb25hbFVuaXQxGDAWBgNVBAMTD0ZvcnQtRnVuc3RvbiBDQTEPMA0GA1UEKRMGc2VydmVyMSEwHwYJKoZIhvcNAQkBFhJtZUBteWhvc3QubXlkb21haW4wHhcNMTcwODI0MDgzMjE3WhcNMjcwODIyMDgzMjE3WjCBrDELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRUwEwYDVQQHEwxTYW5GcmFuY2lzY28xFTATBgNVBAoTDEZvcnQtRnVuc3RvbjEdMBsGA1UECxMUTXlPcmdhbml6YXRpb25hbFVuaXQxDzANBgNVBAMTBm1pbmhudjEPMA0GA1UEKRMGbWluaG52MSEwHwYJKoZIhvcNAQkBFhJtZUBteWhvc3QubXlkb21haW4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQChI36RFmafDHW/j9TkiVw+HHB/NuplulAGwGfMZApONqMpFxJzdPUoaTmc9Zb3wPUXGfkSGEB+8jJ1fWCJqiG9RMe+SGIUj7DWlTkKvUblTAHUfJyeihopo3FbKiya7PqlEUoVMxlOlFT0jRGxlj1rQxJhHckdVsHDR/j+uWGTLY3WWmPZi4YbLl8MsFMe9cIJ10TJEE/Fz61oMkK7k2oGw+1EXG6lU2WgtdGZ9oNHOXD0+Sk57dVnFkeLjInyE3NlreTOUsf/EXlLYGpkK3wTdQQwBv09zXE17XErR51TN3zqp1mv4sR6C+T/F7m5M7qnZAjs8BBcW7mn5xozoqmtAgMBAAGjggF/MIIBezAJBgNVHRMEAjAAMC0GCWCGSAGG+EIBDQQgFh5FYXN5LVJTQSBHZW5lcmF0ZWQgQ2VydGlmaWNhdGUwHQYDVR0OBBYEFI0y4BF+UYFg/RiUZ6DST//g6pUqMIHqBgNVHSMEgeIwgd+AFJSd7DwcQLvM87F5Oue6flW+DlwooYG7pIG4MIG1MQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFTATBgNVBAcTDFNhbkZyYW5jaXNjbzEVMBMGA1UEChMMRm9ydC1GdW5zdG9uMR0wGwYDVQQLExRNeU9yZ2FuaXphdGlvbmFsVW5pdDEYMBYGA1UEAxMPRm9ydC1GdW5zdG9uIENBMQ8wDQYDVQQpEwZzZXJ2ZXIxITAfBgkqhkiG9w0BCQEWEm1lQG15aG9zdC5teWRvbWFpboIJAIGtdvDWt6vhMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsGA1UdDwQEAwIHgDARBgNVHREECjAIggZtaW5obnYwDQYJKoZIhvcNAQELBQADggEBADjolDbpomQH+EZk9v2swvdZOw4tAIpCO8jwXe9Hqz/a8j6of1LrldEjm+I1lhBW93ncqjhiuAxsNGZlf+K5pkYodSXcEXrHckBPaJIvy6LEvLrJ+8GczlHGd8zGcuigrwSRy6Hg/5nffvwkgTHr+O6i9Jdf/f1kpRszYwF+/lhnaZ5/oADhFC6+GHjJP9F2T4tWwf6MU0fc7GpvS95NprQJkl6Q6C31/jmS438wRQXVpEDKruoK5++UUGfMGKURDKR9yxzpSSP5vs+oy7cwNYWh86sxMNy3/u47CZUKaJRhIO7PQDCm1Yzu2O7mEXtaa+982QGyfLs/6zf3zLOVe50=-----END CERTIFICATE-----</cert><key>-----BEGIN PRIVATE KEY-----MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQChI36RFmafDHW/j9TkiVw+HHB/NuplulAGwGfMZApONqMpFxJzdPUoaTmc9Zb3wPUXGfkSGEB+8jJ1fWCJqiG9RMe+SGIUj7DWlTkKvUblTAHUfJyeihopo3FbKiya7PqlEUoVMxlOlFT0jRGxlj1rQxJhHckdVsHDR/j+uWGTLY3WWmPZi4YbLl8MsFMe9cIJ10TJEE/Fz61oMkK7k2oGw+1EXG6lU2WgtdGZ9oNHOXD0+Sk57dVnFkeLjInyE3NlreTOUsf/EXlLYGpkK3wTdQQwBv09zXE17XErR51TN3zqp1mv4sR6C+T/F7m5M7qnZAjs8BBcW7mn5xozoqmtAgMBAAECggEBAJAiTKsAq4hmv8g6ooZNq5nPHH1eJKobzktLvUzgyysMykMN5S4rFsMv5B3Wu1QfX9trGxQpZz9l6uaW4EwjRwyiQjydSEX2BYrbbWuCxLCDnTtwvzM8eox2KwYNolpt0QDnhymRTHiyS493w7Tim0ufcgg2eVdp6+V+MmW+cl4PPHZDLJBVTcmFUPiXpVC7PJlL90Z6vosQjjgCLruX7feuP3jk25ascgKS+vHD0+qC2XWQqDAwFWYPZfb3qvkEgNXjpK+TGjyZbwIckrXkFE5ox/J7qFXNvLeSPsqLYVvOX6OUfuijT1xfd1+ca7ssnmT6trEZPlOh2R2hct3GTK0CgYEA1cA0dH8VuKwpDY5LTOQ7eOdN9flP3daWeWgGjoHGnqjXGAecimsBqs7UT7A1JyT+UD4G5H910JHFQEMrenQqkCHjeBYhJpKtdmnsKVReQsJdtys6n4s+450j5sqRvLwzYJmKmE632aSPK1qIj6eJPSY4uXwVN2vO2DWTMGMUKQMCgYEAwP0dEhYn65SAqcGb/hwEKm6sVDhoXKIFxpLJrsJc70h5Kr9jVICBkDOtI9yC1qQEE7rI042PuHh8wWZbKBNDvpxN1//Imqs89WSUn5arc+cchbOjgAU3PZ4aJC5rPr4MvyV2lUszVAdKJbNNoY/FdoPDQiX9tkQT7Y8ESXk+648CgYBIVmKqJjQQqlq+VrCPFhI2aXkNzFDGD5AfCCBn6+1u1k7st+63PV10E8jwKv7h/3f9afBlNemGKz7o75JwP44D9yQHCN4xMqR3lYMxvXak+yhCC+QsCDDBUPXMbjOB/uMYRv4La2B2zGUTU/ExRI6CXkQGKcL4XYjDzOXCE1XIRwKBgCXjCwv78YZcNw4chkVStral14sJL+PPoxaixplaauhG8BKmVBfIyqbGnl0F82Gz/WDqMHbnualbbhKBx6+MaKZJBTc8beN/bo42Wr8h0zMD0iOlapm9bGTaXwNvYXqF0PbNogQZKVB7xeC03K61DO0BXRnlX3Oi1c6zXwIVnXadAoGAYdfCvWAGrUZXYr7A/RosuBCx+rrf9c/ALhn7mM1q43iVYg2JpfBr998naa1NWRM+V0mxH7b4KK1kRG9omzeau2yihzDDY+d+smHBGKCnrF9UlqDTGC+58jyQYpHvRsHZdgaM9G1N67HwOlBqNxvefOFLEnXaAmDOwD+cCJ+/2o8=-----END PRIVATE KEY-----</key>```