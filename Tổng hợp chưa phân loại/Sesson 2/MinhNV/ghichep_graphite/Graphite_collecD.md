# Tìm hiểu về bộ giải pháp graphite và collectD## I.Tổng quan:Bộ giải pháp này bao gồm các thành phần mã nguồn mở CollectD, Graphite, Grafana và Seyren. Một trong những ưu điểm của việc giám sát này là bạn có thể giám sát hiệu năng mạng và các dữ liệu hệ thống trong các trường hợp không có kết nối mạng công cộng, nghĩa là chỉ chạy trên các mạng cục bộ Isolated hoặc ServiceNet. Một ưu điểm khác là các chỉ số giám sát và các thành phần có khả năng tùy biến cao, linh hoạt để giám sát bất kì ứng dụng hoặc khối lượng công việc nào.## II. Kiến trúcNhư đã nói thì các thành phầ được chạy trên mạng cục bộ, ở đây trong hình mô tả sử dụng dải mạng 192.168.3.0/24. Các chỉ số giám sát(metric) được đẩy bởi các agent collectD lên Graphite server qua daemon carbon-cache trên cổng TCP năm 2003. Graphite-web sẽ đọc các tệp từ whisper cho các điểm dữ liệu vào cho phép chúng truy cập vào Seyren và Grafana.Tất cả các UI dashboardssẽ có thể truy cập qua các cổng khác nhau trên địa chỉ ip công cộng. Graphite server sử dụng ổ SDD để có khả năng đọc ghi dữ liệu nhanh do có 1 số lượng lớn tệp tin được ghi vào whisper.<img src="http://i.imgur.com/ev8saTk.png"> Graphite là hệ thống đồ thị thời gian thực có khả năng mở rộng rất cao. Nó bao gồm 3 thành phần:- Carbon-cache: Một dịch vụ mạng lắng nghe các số liệu đến. Nó lưu trữ các số liệu tạm thời trong bộ đệm bộ nhớ cache trong một thời gian ngắn trước khi xả chúng vào đĩa dưới dạng định dạng cơ sở dữ liệu Whisper.- Whisper: một thư viện cơ sở dữ liệu đơn giản để lưu dữ liệu chuỗi thời gian (tương tự trong thiết kế đến RRD)- Graphite web: Một webapp của Django cho phép đồ thị theo yêu cầu sử dụng Cairo  + Grafana - bảng điều khiển biểu đồ graphite với biểu đồ chỉnh sửa đồ họa mát mẻ và giao diện người dùng trên bảng điều khiển. Nó kéo tất cả các dữ liệu cần thiết từ graphite.  + Seyren - bảng điều khiển cảnh báo cho Graphite. Nó hỗ trợ thông báo qua Email, Flowdock, HipChat, HTTP, Hubot, IRCcat, PagerDuty, Pushover, SLF4J, Slack, SNMP, Twilio.Ngoài ra còn có CollectD, nó là một daemon thu thập thống kê hiệu suất hệ thống và cung cấp các cơ chế để lưu trữ các giá trị bằng nhiều cách### 1. Whisper#### 1.1 Whisper là gì?Whisper là một cơ sở dữ liệu có kích thước cố định, tương tự như thiết kế và mục đích của RRD (round-robin-database). Cung cấp khả năng lưu trữ dữ liệu số nhanh và đáng tin cậy qua thời gian. Whisper cho phép độ phân giải cao hơn (giây mỗi điểm) của dữ liệu gần đây để phân hủy thành các độ phân giải thấp hơn để duy trì lâu dài dữ liệu lịch sử.**Whisper tương tự thiết kế và mục đích của RRD? Vậy RRD là gì?**<ul>Một hệ thống lưu trữ chuyên dụng gọi là Round Robin Database cho phép lưu trữ một lượng lớn các thông tin theo thời gian như nhiệt độ, băng thông mạng và giá cổ phiếu và ghi dữ liệu vào đĩa liên tục. Nó thực hiện điều này bằng cách tận dụng các nhu cầu thay đổi cho độ chính xác.</ul><ul>Trong ngắn hạn, mỗi điểm dữ liệu là quan trọng: chúng tôi muốn có một bức tranh chính xác về mọi sự kiện đã xảy ra trong 24 giờ qua, có thể bao gồm các đột biến nhỏ trong việc sử dụng đĩa hoặc băng thông mạng (có thể chỉ ra một cuộc tấn công). Tuy nhiên về lâu dài, chỉ cần các xu hướng chung là đủ.</ul><ul>Ví dụ: nếu chúng ta lấy mẫu tín hiệu ở khoảng 5 phút thì khoảng thời gian 24 giờ sẽ có 288 điểm dữ liệu (24 giờ * 60 phút / giờ chia cho 5 phút cho mỗi mẫu).</ul><ul>Để tiết kiệm không gian, chúng ta có thể thu thập dữ liệu cũ bằng chức năng Hợp nhất (CF), thực hiện một số tính toán trên nhiều điểm dữ liệu để kết hợp nó vào một điểm duy nhất trong một khoảng thời gian dài hơn. Hãy tưởng tượng rằng chúng tôi lấy trung bình của 288 mẫu vào cuối mỗi 24 giờ; Trong trường hợp đó, chúng tôi chỉ cần 365 điểm dữ liệu để lưu trữ dữ liệu cho cả năm</ul><ul>Nhưng RRD không chấp nhận các data bất thường, nếu metric A với mốc thời gian là 5:05:00 đến sau metric B với mốc thời gian 5:05:30, metric đến trước sẽ bị loại bỏ hoàn toàn bởi RRD ( điều này sẽ được thiết kế lại về sau). Whisper giải quyết thiết kế thiếu sót này một cách đặc biệt, và tại cùng một thời điểm như nhau, đơn giản hóa cấu hình và bố trí thời gian lưu trữ với mỗi database file.</ul>Whisper, một thư viện database, là một nỗ lực tuyệt vọng để sửa một lỗi khẩn cấp với RRD trước ngày ra mắt quan trọng.Whisper là 1 trong 2 thành phần của time-series database.Graphite sử dụng cả hai kỹ thuật này để hỗ trợ việc thực hiện các thành phần time-series database :- Carbon : một network service có nhiệm vụ lắng nghe các trình báo về metric đầu vào. Nó lưu trữ các dữ liệu một cách tạm thời trong bộ nhớ đệm trong một khoảng thời gian ngắn trước khi thực hiện quá trình đẩy chúng tới disk theo định dạng của Whisper database format.- Whisper : Đặc điểm kỹ thuật của database file layout, bao gồm metadata và các lưu trữ rollup, cũng như là chương trình thư viện mà cả Carbon và Graphite web application dùng để tương tác với các database file tương ứng.Trong đó có 1 số thuật ngữ mà tôi nhắc tới:- Time-Series Databases Time-series database là một hệ thống phần mềm dùng cho việc lưu trữ và thu thập time-series data. Hiệu năng và sự bền vững của một TSDB (Time Series Database) thường là một nhân tố chính khi đánh giá các các hệ thống xu hướng phần mềm như Graphite.- Lưu trữ rollup là các phương pháp tổng hợp dữ liệu. Các phương pháp tổng hợp dữ liệu có sẵn là: average, sum, last, max, min.### 2.CarbonCarbon là một thành phần của Graphite, nhận các metric, cache các metric này vào bộ nhớ memory (RAM), trước khi đẩy xuống storage backend để lưu trữ, Graphite web cũng có thể query dữ liệu trực tiếp trên lớp cache này. #### 2.1.Carbon-cachecarbon-cache sẽ cache các metric trong RAM mỗi khi nhận được metric mới, sau đó flush xuống storge backend theo từng khoảng thời gian(backend mặc định là whisper). Nó cũng cho phép query các metric datapoint in-memory, giúp Graphite web app có thể sử dụng các "hot data" metric .Khi số lượng metric tăng lên, một daemon carbon-cache không thể xử lý hết các IO load. Để mở rộng, chạy các instance carbon-cache đằng sau daemon carbon-aggregator hoặc carbon-relay.Cấu hình:- carbon.conf: khai báo các port, giao thức và phương thức để nhận metric- storate-schemas.conf: khai báo các policy để lưu trữ metric và lọc các metric được lưu trữ dựa trên regex pattern.#### 2.2.Carbon-relaycarbon-relay đảm nhiệm 2 vai trò: nhân bản và phân tán.- Với cơ chế RELAY_METHOD = rules, carbon-relay sẽ chuyển tiếp các metric đến các backend carbon-cache trên nhiều host dựa trên pattern định nghĩa trong file relay-rules.conf.- Với cơ chế RELAY_METHOD = consistent-hashing, carbon-relay sẽ phân tán(sharding) các metric tới các carbon-cache backend trên các host được khai báo trong trường DESTINATIONSCấu hình:- carbon.conf: định nghĩa host và port nhận metric.- relay-rules.conf: định nghĩa ra các regex pattern, metric match với mẫu regex nào thì sẽ được đẩy về host carbon-cache tương ứng.#### 2.3.Carbon-aggregatordaemon này đặt ở trước carbon-cache để buffer các metric trước khi đẩy vào whisper. Nó giúp làm giảm I/O load và kích thước file trên whisper bằng cách định nghĩa các khoảng thời gian và các hàm để aggregate các metric (sum hoặc average) khớp với regex pattern cho trước. Sau 1 khoảng thời gian, các metric sau khi được aggregate sẽ được đẩy xuống carbon-cache.Cấu hình:carbon.conf: định nghĩa host và port nhận metric.aggregation-rules.conf: định nghĩa khoảng thời gian và hàm để thực hiện aggregate cho các metric khớp với các regex pattern. file này có dạng như sau: output_template (frequency) = method input_pattern